pipeline {
    agent none

    parameters {
        string(
            name: 'BRANCH_NAME',
            defaultValue: 'main',
            description: 'Git branch to build (e.g., main, develop, feature/xxx)'
        )
        booleanParam(
            name: 'TRIGGER_TEST',
            defaultValue: true,
            description: 'Trigger test pipeline after build completes'
        )
        string(
            name: 'TAG_PREFIX',
            defaultValue: 'raspi-img',
            description: 'Prefix for image tag (e.g., raspi-img, v, release)'
        )
    }

    environment {
        PLATFORM = "RaspberryPi"
        IMAGE_ARTIFACT = "raspberrypi-image.img"
    }

    stages {

        stage('Checkout Source') {
            agent { label 'fw-build' }
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: "*/${params.BRANCH_NAME}"]],
                    doGenerateSubmoduleConfigurations: false,
                    extensions: [],
                    submoduleCfg: [],
                    userRemoteConfigs: scm.userRemoteConfigs
                ])
            }
        }

        stage('Build Raspberry Pi Image') {
            agent { label 'fw-build' }
            steps {
                sh '''
                    echo "[${PLATFORM}] Building image..."
                    # TODO: Add actual build commands for Raspberry Pi
                    # Example: docker build, yocto, buildroot, etc.
                    touch ${IMAGE_ARTIFACT}
                    echo "Image built: ${IMAGE_ARTIFACT}"
                '''
            }
        }

        stage('Archive Image Artifact') {
            agent { label 'fw-build' }
            steps {
                archiveArtifacts artifacts: "${IMAGE_ARTIFACT}", fingerprint: true
            }
        }

        stage('Generate ATS Manifest') {
            agent { label 'fw-build' }
            steps {
                sh '''
                    SHA256=$(sha256sum ${IMAGE_ARTIFACT} | awk '{print $1}')

                    cat <<EOF > ats-manifest.yaml
manifest_version: 1

build:
  ci_system: jenkins
  job_name: ${JOB_NAME}
  build_number: ${BUILD_NUMBER}
  git:
    repo: ${GIT_URL}
    commit: ${GIT_COMMIT}
    branch: ${GIT_BRANCH}
  artifact:
    name: ${IMAGE_ARTIFACT}
    checksum: sha256:${SHA256}
    build_node: xeon-fw-build

device:
  target: raspberrypi
  board: raspberrypi-4

test_plan:
  - boot_test
  - gpio_test
  - network_test

timestamps:
  build_time: "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
EOF
                '''
                archiveArtifacts artifacts: 'ats-manifest.yaml'
            }
        }

        stage('Tag Image') {
            agent { label 'fw-build' }
            steps {
                script {
                    def tagName = "${params.TAG_PREFIX}-${env.BUILD_NUMBER}-${env.GIT_COMMIT.take(7)}"
                    def tagMessage = "Raspberry Pi image build #${env.BUILD_NUMBER} from ${env.GIT_BRANCH}"
                    
                    sh """
                        git config user.name "Jenkins"
                        git config user.email "jenkins@ats-ci"
                        git tag -a ${tagName} -m "${tagMessage}"
                        git push origin ${tagName} || echo "Tag push failed (may already exist)"
                    """
                    
                    echo "‚úÖ Tagged image: ${tagName}"
                }
            }
        }

        stage('Trigger Test Pipeline') {
            when {
                expression { params.TRIGGER_TEST == true }
            }
            steps {
                script {
                    def testJobName = "${env.JOB_NAME}-${env.PLATFORM}-test"
                    echo "üöÄ Triggering test pipeline: ${testJobName}"
                    
                    def testBuild = build job: testJobName, 
                        parameters: [
                            string(name: 'BUILD_JOB_NAME', value: env.JOB_NAME),
                            string(name: 'BUILD_NUMBER', value: env.BUILD_NUMBER.toString()),
                            string(name: 'FW_ARTIFACT', value: env.IMAGE_ARTIFACT),
                            string(name: 'PLATFORM', value: env.PLATFORM)
                        ],
                        wait: false,
                        propagate: false
                    
                    echo "‚úÖ Test pipeline triggered: ${testJobName} #${testBuild.number}"
                }
            }
        }
    }

    post {
        success {
            echo "‚úÖ Image built and tagged successfully"
        }
        failure {
            echo "‚ùå Image build failed"
        }
        always {
            node('fw-build') {
                archiveArtifacts artifacts: 'ats-manifest.yaml', allowEmptyArchive: true
            }
        }
    }
}

