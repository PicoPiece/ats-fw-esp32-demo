pipeline {
    agent none

    parameters {
        string(
            name: 'BUILD_JOB_NAME',
            defaultValue: 'platforms/ESP32/ats-fw-esp32-demo',
            description: 'Name of the build job that produced the firmware (with folder path)'
        )
        string(
            name: 'BUILD_NUMBER',
            defaultValue: '',
            description: 'Build number of the firmware to test'
        )
        string(
            name: 'FW_ARTIFACT',
            defaultValue: 'firmware-esp32.bin',
            description: 'Firmware artifact name'
        )
        string(
            name: 'PLATFORM',
            defaultValue: 'ESP32',
            description: 'Platform name (ESP32, RaspberryPi, nRF52, ...)'
        )
        string(
            name: 'ATS_NODE_LABEL',
            defaultValue: 'ats-node',
            description: 'Label for ATS node pool (e.g., ats-node, ats-pi-01)'
        )
        string(
            name: 'TEST_REPO_URL',
            defaultValue: 'https://github.com/PicoPiece/ats-test-esp32-demo.git',
            description: 'Git URL of the test framework repository'
        )
        string(
            name: 'TEST_REPO_BRANCH',
            defaultValue: 'main',
            description: 'Branch of the test framework repository to use'
        )
    }

    environment {
        TEST_REPORT_DIR = "reports"
        TEST_REPO_DIR = "ats-test-esp32-demo"
    }

    stages {
        stage('Checkout Test Framework') {
            agent { label "${params.ATS_NODE_LABEL}" }
            steps {
                echo "üì¶ Checking out test framework: ${params.TEST_REPO_URL}"
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: "*/${params.TEST_REPO_BRANCH}"]],
                    doGenerateSubmoduleConfigurations: false,
                    extensions: [[
                        $class: 'RelativeTargetDirectory',
                        relativeTargetDir: env.TEST_REPO_DIR
                    ]],
                    submoduleCfg: [],
                    userRemoteConfigs: [[
                        url: params.TEST_REPO_URL,
                        credentialsId: ''
                    ]]
                ])
                
                sh """
                    echo "‚úÖ Test framework checked out to: ${env.TEST_REPO_DIR}"
                    ls -la ${env.TEST_REPO_DIR}/agent/ 2>/dev/null || echo "‚ö†Ô∏è  agent/ directory not found in ${env.TEST_REPO_DIR}"
                    echo "üìÅ Repository structure:"
                    ls -la ${env.TEST_REPO_DIR}/ 2>/dev/null | head -10
                """
            }
        }

        stage('Copy Firmware Artifact') {
            agent { label "${params.ATS_NODE_LABEL}" }
            steps {
                script {
                    if (!params.BUILD_NUMBER || params.BUILD_NUMBER == '') {
                        error("BUILD_NUMBER parameter is required")
                    }
                    
                    echo "üì• Copying firmware from ${params.BUILD_JOB_NAME} #${params.BUILD_NUMBER}"
                    
                    copyArtifacts(
                        projectName: params.BUILD_JOB_NAME,
                        selector: specific(params.BUILD_NUMBER),
                        filter: "${params.FW_ARTIFACT},ats-manifest.yaml",
                        target: "${env.TEST_REPO_DIR}",
                        flatten: true
                    )
                    
                    sh """
                        echo "‚úÖ Firmware artifact copied to test framework:"
                        ls -lh ${env.TEST_REPO_DIR}/${params.FW_ARTIFACT} || echo "‚ùå Firmware not found"
                        ls -lh ${env.TEST_REPO_DIR}/ats-manifest.yaml || echo "‚ö†Ô∏è  Manifest not found"
                    """
                }
            }
        }

        stage('Build Test Container') {
            agent { label "${params.ATS_NODE_LABEL}" }
            steps {
                dir(env.TEST_REPO_DIR) {
                    sh """
                        echo "üê≥ [ATS] Building test container for ${PLATFORM}"
                        echo "üìÅ Working directory: \$(pwd)"
                        
                        # Build Docker image if Dockerfile exists
                        if [ -f Dockerfile ]; then
                            docker build -t ats-test-runner:${PLATFORM,,} .
                            echo "‚úÖ Test container built successfully"
                        else
                            echo "‚ö†Ô∏è  Dockerfile not found, using pre-built image"
                        fi
                    """
                }
            }
        }

        stage('Flash Firmware') {
            agent { label "${params.ATS_NODE_LABEL}" }
            steps {
                dir(env.TEST_REPO_DIR) {
                    sh """
                        echo "[ATS] Flashing ${PLATFORM} firmware: ${FW_ARTIFACT}"
                        echo "üê≥ Running in Docker container with hardware access"
                        
                        # Run flash script in Docker container with hardware access
                        # Using specific device mounts instead of --privileged for security
                        docker run --rm \\
                            --device=/dev/ttyUSB0 \\
                            --device=/dev/ttyUSB1 \\
                            --device=/dev/ttyACM0 \\
                            --device=/dev/ttyACM1 \\
                            --cap-add=SYS_RAWIO \\
                            -v \$(pwd):/app \\
                            -w /app \\
                            ats-test-runner:${PLATFORM,,} \\
                            ./agent/flash_fw.sh ${FW_ARTIFACT} ${PLATFORM}
                    """
                }
            }
        }

        stage('Run Tests') {
            agent { label "${params.ATS_NODE_LABEL}" }
            steps {
                dir(env.TEST_REPO_DIR) {
                    sh """
                        echo "[ATS] Running hardware tests for ${PLATFORM}"
                        echo "üìÅ Working directory: \$(pwd)"
                        echo "üìã Test manifest:"
                        cat ats-manifest.yaml 2>/dev/null || echo "‚ö†Ô∏è  Manifest not found"
                        
                        mkdir -p ${TEST_REPORT_DIR}
                        
                        # Run tests in Docker container with hardware access
                        # Using specific device mounts and capabilities instead of --privileged for security
                        docker run --rm \\
                            --device=/dev/ttyUSB0 \\
                            --device=/dev/ttyUSB1 \\
                            --device=/dev/ttyACM0 \\
                            --device=/dev/ttyACM1 \\
                            --cap-add=SYS_RAWIO \\
                            --cap-add=SYS_ADMIN \\
                            -v /sys/class/gpio:/sys/class/gpio:ro \\
                            -v /dev/gpiomem:/dev/gpiomem \\
                            -v \$(pwd):/app \\
                            -w /app \\
                            -e TEST_REPORT_DIR=/app/${TEST_REPORT_DIR} \\
                            -e ESP32_GPIO_PIN=\${ESP32_GPIO_PIN:-2} \\
                            ats-test-runner:${PLATFORM,,} \\
                            ./agent/run_tests.sh ${FW_ARTIFACT} ${PLATFORM}
                        
                        echo "‚úÖ Test execution completed"
                        echo "üìä Test reports:"
                        ls -la ${TEST_REPORT_DIR}/ 2>/dev/null || echo "   No reports generated"
                    """
                }
            }
        }

        stage('Archive Test Reports') {
            agent { label "${params.ATS_NODE_LABEL}" }
            steps {
                dir(env.TEST_REPO_DIR) {
                    archiveArtifacts artifacts: "${TEST_REPORT_DIR}/**", allowEmptyArchive: true
                    publishTestResults testResultsPattern: "${TEST_REPORT_DIR}/**/*.xml", allowEmptyResults: true
                }
            }
        }
    }

    post {
        success {
            echo "‚úÖ Firmware tested successfully on ATS node"
        }
        failure {
            echo "‚ùå Firmware test failed"
        }
        always {
            node("${params.ATS_NODE_LABEL}") {
                dir(env.TEST_REPO_DIR) {
                    archiveArtifacts artifacts: "${TEST_REPORT_DIR}/**", allowEmptyArchive: true
                }
            }
        }
    }
}

