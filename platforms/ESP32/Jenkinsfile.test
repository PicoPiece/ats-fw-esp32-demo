pipeline {
    agent none

    parameters {
        string(
            name: 'BUILD_JOB_NAME',
            defaultValue: 'platforms/ESP32/ats-fw-esp32-demo',
            description: 'Name of the build job that produced the firmware (with folder path)'
        )
        string(
            name: 'BUILD_NUMBER',
            defaultValue: '',
            description: 'Build number of the firmware to test'
        )
        string(
            name: 'ATS_NODE_LABEL',
            defaultValue: 'raspi-ats-01',
            description: 'Label for ATS node pool (e.g., ats-node, ats-pi-01)'
        )
        choice(
            name: 'IMAGE_SOURCE',
            choices: ['registry', 'build'],
            description: 'How to get ats-node-test image: pull from registry or build on agent'
        )
        string(
            name: 'ATS_NODE_TEST_IMAGE',
            defaultValue: 'ghcr.io/picopiece/ats-node-test:latest',
            description: 'Docker image name for ATS node test container (registry or local)'
        )
        string(
            name: 'TEST_REPO_URL',
            defaultValue: 'https://github.com/PicoPiece/ats-test-esp32-demo.git',
            description: 'Git URL of the test framework repository'
        )
        string(
            name: 'TEST_REPO_BRANCH',
            defaultValue: 'main',
            description: 'Branch of the test framework repository to use'
        )
    }

    environment {
        WORKSPACE_DIR = "workspace"
        RESULTS_DIR = "results"
        TEST_REPO_DIR = "ats-test-esp32-demo"
    }

    stages {
        stage('Prepare Workspace') {
            agent { label "${params.ATS_NODE_LABEL}" }
            steps {
                script {
                    if (!params.BUILD_NUMBER || params.BUILD_NUMBER == '') {
                        error("BUILD_NUMBER parameter is required")
                    }
                    
                    // Create workspace directory
                    sh """
                        mkdir -p ${WORKSPACE_DIR}
                        cd ${WORKSPACE_DIR}
                    """
                    
                    // Copy firmware artifacts from build job
                    echo "üì• Copying firmware artifacts from ${params.BUILD_JOB_NAME} #${params.BUILD_NUMBER}"
                    
                    // Copy artifacts in two steps to ensure both are copied
                    copyArtifacts(
                        projectName: params.BUILD_JOB_NAME,
                        selector: [
                            $class: 'SpecificBuildSelector',
                            buildNumber: params.BUILD_NUMBER.toString()
                        ],
                        filter: "*.bin",
                        target: WORKSPACE_DIR,
                        flatten: true
                    )
                    
                    copyArtifacts(
                        projectName: params.BUILD_JOB_NAME,
                        selector: [
                            $class: 'SpecificBuildSelector',
                            buildNumber: params.BUILD_NUMBER.toString()
                        ],
                        filter: "ats-manifest.yaml",
                        target: WORKSPACE_DIR,
                        flatten: true
                    )
                    
                    // Verify artifacts were copied
                    sh """
                        echo "üì¶ Copied artifacts:"
                        ls -lh ${WORKSPACE_DIR}/*.bin 2>/dev/null || echo "‚ö†Ô∏è  No .bin files found"
                        ls -lh ${WORKSPACE_DIR}/ats-manifest.yaml 2>/dev/null || echo "‚ö†Ô∏è  Manifest not found"
                        echo ""
                    """
                    
                    // Checkout test framework
                    echo "üì¶ Checking out test framework: ${params.TEST_REPO_URL}"
                    dir(WORKSPACE_DIR) {
                        checkout([
                            $class: 'GitSCM',
                            branches: [[name: "*/${params.TEST_REPO_BRANCH}"]],
                            doGenerateSubmoduleConfigurations: false,
                            extensions: [[
                                $class: 'RelativeTargetDirectory',
                                relativeTargetDir: TEST_REPO_DIR
                            ]],
                            submoduleCfg: [],
                            userRemoteConfigs: [[
                                url: params.TEST_REPO_URL,
                                credentialsId: ''
                            ]]
                        ])
                    }
                    
                    // Verify workspace structure
                    sh """
                        echo "‚úÖ Workspace prepared:"
                        ls -lh ${WORKSPACE_DIR}/
                        echo ""
                        echo "üìã Manifest verification:"
                        if [ -f ${WORKSPACE_DIR}/ats-manifest.yaml ]; then
                            echo "‚úÖ Manifest found:"
                            cat ${WORKSPACE_DIR}/ats-manifest.yaml
                        else
                            echo "‚ùå Manifest NOT found in ${WORKSPACE_DIR}/"
                            echo "   Current directory contents:"
                            ls -la ${WORKSPACE_DIR}/
                            exit 1
                        fi
                    """
                }
            }
        }

        stage('Prepare ATS Node Test Container') {
            agent { label "${params.ATS_NODE_LABEL}" }
            steps {
                script {
                    if (params.IMAGE_SOURCE == 'registry') {
                        // Option 1: Pull from registry (fast, recommended)
                        echo "üì• Pulling ATS node test image from registry..."
                        def pullSuccess = sh(
                            script: "docker pull ${params.ATS_NODE_TEST_IMAGE}",
                            returnStatus: true
                        ) == 0
                        
                        if (pullSuccess) {
                            echo "‚úÖ Image pulled successfully: ${params.ATS_NODE_TEST_IMAGE}"
                        } else {
                            echo "‚ö†Ô∏è  Failed to pull image from registry, falling back to build..."
                            // Fall back to build
                            def atsNodeRepo = "${WORKSPACE_DIR}/ats-ats-node"
                            sh """
                                if [ ! -d "${atsNodeRepo}" ]; then
                                    echo "üì¶ Cloning ats-ats-node repository..."
                                    cd ${WORKSPACE_DIR}
                                    git clone https://github.com/PicoPiece/ats-ats-node.git || {
                                        echo "‚ùå Failed to clone ats-ats-node"
                                        exit 1
                                    }
                                fi
                                
                                if [ -d "${atsNodeRepo}/docker/ats-node-test" ]; then
                                    echo "üê≥ Building ATS node test container (fallback)..."
                                    cd ${atsNodeRepo}/docker/ats-node-test
                                    docker build -t ${params.ATS_NODE_TEST_IMAGE} .
                                    echo "‚úÖ Container built: ${params.ATS_NODE_TEST_IMAGE}"
                                else
                                    echo "‚ùå Dockerfile not found: ${atsNodeRepo}/docker/ats-node-test"
                                    exit 1
                                fi
                            """
                        }
                    } else {
                        // Option 2: Build on agent (slow, but works without registry)
                        echo "üî® Building ATS node test container on agent..."
                        def atsNodeRepo = "${WORKSPACE_DIR}/ats-ats-node"
                        sh """
                            # Checkout ats-ats-node repo if not present
                            if [ ! -d "${atsNodeRepo}" ]; then
                                echo "üì¶ Cloning ats-ats-node repository..."
                                cd ${WORKSPACE_DIR}
                                git clone https://github.com/PicoPiece/ats-ats-node.git || {
                                    echo "‚ùå Failed to clone ats-ats-node"
                                    exit 1
                                }
                            fi
                            
                            # Build ats-node-test container
                            if [ -d "${atsNodeRepo}/docker/ats-node-test" ]; then
                                echo "üê≥ Building ATS node test container..."
                                cd ${atsNodeRepo}/docker/ats-node-test
                                docker build -t ${params.ATS_NODE_TEST_IMAGE} .
                                echo "‚úÖ Container built: ${params.ATS_NODE_TEST_IMAGE}"
                            else
                                echo "‚ùå Dockerfile not found: ${atsNodeRepo}/docker/ats-node-test"
                                exit 1
                            fi
                        """
                    }
                }
            }
        }

        stage('Run ATS Tests') {
            agent { label "${params.ATS_NODE_LABEL}" }
            steps {
                dir(WORKSPACE_DIR) {
                    sh """
                        echo "üöÄ [ATS] Running test execution container"
                        echo "üìã Image: ${params.ATS_NODE_TEST_IMAGE}"
                        echo "üìÅ Workspace: \$(pwd)"
                        
                        # Create results directory
                        mkdir -p ${RESULTS_DIR}
                        
                        # Run ats-node-test container
                        # Container will:
                        # 1. Load manifest from /workspace/ats-manifest.yaml
                        # 2. Flash firmware
                        # 3. Run tests
                        # 4. Write results to /workspace/results/
                        docker run --rm --privileged \\
                            -v /dev:/dev \\
                            -v /sys/class/gpio:/sys/class/gpio:ro \\
                            -v /dev/gpiomem:/dev/gpiomem \\
                            -v \$(pwd):/workspace \\
                            -e MANIFEST_PATH=/workspace/ats-manifest.yaml \\
                            -e RESULTS_DIR=/workspace/${RESULTS_DIR} \\
                            ${params.ATS_NODE_TEST_IMAGE}
                        
                        echo "‚úÖ Test execution completed"
                        echo "üìä Results:"
                        ls -la ${RESULTS_DIR}/ || echo "   No results found"
                    """
                }
            }
        }

        stage('Archive Results') {
            agent { label "${params.ATS_NODE_LABEL}" }
            steps {
                dir(WORKSPACE_DIR) {
                    archiveArtifacts artifacts: "${RESULTS_DIR}/**", allowEmptyArchive: true
                    publishTestResults testResultsPattern: "${RESULTS_DIR}/**/*.xml", allowEmptyResults: true
                }
            }
        }
    }

    post {
        success {
            echo "‚úÖ Firmware tested successfully on ATS node"
        }
        failure {
            echo "‚ùå Firmware test failed"
        }
        always {
            node("${params.ATS_NODE_LABEL}") {
                dir(WORKSPACE_DIR) {
                    archiveArtifacts artifacts: "${RESULTS_DIR}/**", allowEmptyArchive: true
                }
            }
        }
    }
}
